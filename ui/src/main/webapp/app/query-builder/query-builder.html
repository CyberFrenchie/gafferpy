<!--
  ~ Copyright 2017 Crown Copyright
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<form ng-cloak>
    <md-toolbar>
        <div class="md-toolbar-tools">
            <h2 class="md-display-1">Build Operation</h2>
        </div>
    </md-toolbar>

    <md-dialog-content>
        <div class="md-dialog-content">
            <md-tabs md-dynamic-height md-border-bottom
                     md-selected="ctrl.step">
                <md-tab label="Choose operation"
                        ng-disabled="ctrl.step != 0">

                </md-tab>

                <md-tab label="Configure Operation"
                        ng-disabled="ctrl.step != 1">
                    <div ng-show="ctrl.selectedOp.input">
                        <h3 class="md-headline">
                            Selected seeds
                            <md-button id="select-all-seeds"
                                       ng-click="ctrl.selectAllSeeds()"
                                       class="md-raised">
                                Select all
                            </md-button>
                        </h3>

                        <p ng-repeat="(vertex, entities) in ctrl.selectedEntities">
                            {{vertex}}
                        </p>

                        <p ng-show="!ctrl.selectedEntities || ctrl.selectedEntities.length == 0">
                            No seeds selected.
                        </p>
                    </div>

                    <div ng-show="ctrl.selectedOp.parameters">
                        <label for="parameters">Parameters</label>

                        <table md-table id="parameters">
                            <thead md-head>
                            <tr md-row>
                                <th md-column>
                                    Name
                                </th>
                                <th md-column>
                                    Description
                                </th>
                                <th md-column>
                                    Required
                                </th>
                                <th md-column>
                                    Value
                                </th>
                            </tr>
                            </thead>
                            <tbody md-body>
                            <tr ng-repeat="(name, detail) in ctrl.selectedOp.parameters" md-row>
                                <td md-cell>
                                    {{name}}
                                </td>
                                <td md-cell>
                                    {{detail.description}}
                                </td>
                                <td md-cell>
                                    {{detail.required}}
                                </td>
                                <td md-cell>
                                    <div layout="row" layout-wrap>
                                        <div ng-repeat="field in ctrl.getFields(detail.valueClass)">
                                            <md-input-container>
                                                <label>{{field.label}}</label>
                                                <input id="param-{{name}}-{{field.key}}"
                                                       type="{{field.type}}"
                                                       step="{{field.step}}"
                                                       ng-model="detail.parts[field.key]"/>
                                            </md-input-container>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <div ng-show="ctrl.selectedOp.view">
                        <h3 class="md-headline">Configure View</h3>

                        <p>
                            If you don't select any Entities or Edges
                            then all Entities and Edges will be
                            returned.
                        </p>

                        <h4 class="md-title">Entities</h4>

                        <p ng-show="!ctrl.relatedEntities || ctrl.relatedEntities.length === 0">
                            No related entities
                        </p>

                        <div ng-repeat="entity in ctrl.relatedEntities">
                            <md-checkbox
                                    id="related-entity-{{entity}}"
                                    ng-checked="ctrl.exists(ctrl.expandEntities, entity)"
                                    ng-click="ctrl.toggle(entity, ctrl.expandEntities)">
                                {{entity}}
                            </md-checkbox>

                            <div ng-show="ctrl.exists(ctrl.expandEntities, entity)">
                                <table md-table
                                       ng-show="ctrl.getEntityProperties(entity)">
                                    <tbody md-body>
                                    <tr md-row ng-repeat="filter in ctrl.expandEntitiesContent[entity].filters.preAggregation">
                                        <td md-cell>
                                            <md-input-container flex>
                                                <label>Select a property</label>
                                                <md-select id="{{entity}}-pre-property-selector"
                                                           ng-model="filter.property"
                                                           ng-change="ctrl.onSelectedPropertyChange(entity, filter)">
                                                    <md-option ng-repeat="(name, type) in ctrl.getEntityProperties(entity)" ng-value="name">{{name}}</md-option>
                                                </md-select>
                                            </md-input-container>
                                        </td>
                                        <td md-cell>
                                            <md-input-container flex>
                                                <label>Select a predicate</label>
                                                <md-select
                                                        id="{{entity}}-pre-{{filter.property}}-predicate-selector"
                                                        ng-model="filter.predicate"
                                                        ng-change="ctrl.onSelectedFunctionChange(entity, filter)">
                                                    <md-option ng-repeat="predicate in filter.availableFunctions" ng-value="predicate">{{predicate}}</md-option>
                                                </md-select>
                                            </md-input-container>
                                        </td>

                                        <td md-cell>
                                            <div layout="row" layout-padding layout-align="center center">
                                                <div layout="column" flex="50">
                                                    <md-input-container ng-repeat="(idx, param) in filter.availableFunctionParameters">
                                                        <label>{{param}}</label>
                                                        <input type="text"
                                                               id="{{entity}}-pre-{{filter.property}}-{{filter.predicate}}-{{param}}"
                                                               ng-model="filter.parameters[idx]">
                                                    </md-input-container>
                                                </div>
                                                <p ng-show="filter.availableFunctionParameters.length > 0 && filter.propertyClass" flex="50">
                                                    You may need to
                                                    explicitly
                                                    tell Gaffer the type of
                                                    the
                                                    parameter, e.g:
                                                    {"{{filter.propertyClass}}":
                                                    value}
                                                </p>
                                            </div>

                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                                <md-button id="{{entity}}-add-pre-filter"
                                           ng-click="ctrl.addFilterFunction(ctrl.expandEntitiesContent, entity, true)"
                                           ng-show="ctrl.getEntityProperties(entity)">
                                    Add Pre Aggregation filter
                                </md-button>
                                <table md-table
                                       ng-show="ctrl.getEntityProperties(entity)">
                                    <tbody md-body>
                                    <tr md-row ng-repeat="filter in ctrl.expandEntitiesContent[entity].filters.postAggregation">
                                        <td md-cell>
                                            <md-input-container flex>
                                                <label>Select a property</label>
                                                <md-select id="{{entity}}-post-property-selector"
                                                           ng-model="filter.property"
                                                           ng-change="ctrl.onSelectedPropertyChange(entity, filter)">
                                                    <md-option ng-repeat="(name, type) in ctrl.getEntityProperties(entity)" ng-value="name">{{name}}</md-option>
                                                </md-select>
                                            </md-input-container>
                                        </td>
                                        <td md-cell>
                                            <md-input-container flex>
                                                <label>Select a predicate</label>
                                                <md-select
                                                        id="{{entity}}-post-{{filter.property}}-predicate-selector"
                                                        ng-model="filter.predicate"
                                                        ng-change="ctrl.onSelectedFunctionChange(entity, filter)">
                                                    <md-option ng-repeat="predicate in filter.availableFunctions" ng-value="predicate">{{predicate}}</md-option>
                                                </md-select>
                                            </md-input-container>
                                        </td>

                                        <td md-cell>
                                            <div layout="row" layout-padding layout-align="center center">
                                                <div layout="column" flex="50">
                                                    <md-input-container ng-repeat="(idx, param) in filter.availableFunctionParameters">
                                                        <label>{{param}}</label>
                                                        <input type="text"
                                                               id="{{entity}}-post-{{filter.property}}-{{filter.predicate}}-{{param}}"
                                                               ng-model="filter.parameters[idx]">
                                                    </md-input-container>
                                                </div>
                                                <p ng-show="filter.availableFunctionParameters.length > 0 && filter.propertyClass" flex="50">
                                                    You may need to
                                                    explicitly
                                                    tell Gaffer the type of
                                                    the
                                                    parameter, e.g:
                                                    {"{{filter.propertyClass}}":
                                                    value}
                                                </p>
                                            </div>

                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                                <md-button id="{{entity}}-add-post-filter"
                                           ng-click="ctrl.addFilterFunction(ctrl.expandEntitiesContent, entity, false)"
                                           ng-show="ctrl.getEntityProperties(entity)">
                                    Add Post Aggregation filter
                                </md-button>
                            </div>
                        </div>


                        <h4 class="md-title">Edges</h4>

                        <p ng-show="!ctrl.relatedEdges || ctrl.relatedEdges.length === 0">
                            No related edges
                        </p>

                        <div ng-repeat="edge in ctrl.relatedEdges">
                            <md-checkbox
                                    id="related-edge-{{edge}}"
                                    ng-checked="ctrl.exists(ctrl.expandEdges, edge)"
                                    ng-click="ctrl.toggle(edge, ctrl.expandEdges)">
                                {{edge}}
                            </md-checkbox>

                            <div ng-show="ctrl.exists(ctrl.expandEdges, edge)">
                                <table md-table
                                       ng-show="ctrl.getEdgeProperties(edge)">
                                    <tbody md-body>
                                    <tr md-row ng-repeat="filter in ctrl.expandEdgesContent[edge].filters.preAggregation">
                                        <td md-cell>
                                            <md-input-container flex>
                                                <label>Select a property</label>
                                                <md-select id="{{edge}}-pre-property-selector"
                                                           ng-model="filter.property"
                                                           ng-change="ctrl.onSelectedPropertyChange(edge, filter)">
                                                    <md-option ng-repeat="(name, type) in ctrl.getEdgeProperties(edge)" ng-value="name">{{name}}</md-option>
                                                </md-select>
                                            </md-input-container>
                                        </td>
                                        <td md-cell>
                                            <md-input-container flex>
                                                <label>Select a predicate</label>
                                                <md-select
                                                        id="{{edge}}-pre-{{filter.property}}-predicate-selector"
                                                        ng-model="filter.predicate"
                                                        ng-change="ctrl.onSelectedFunctionChange(edge, filter)">
                                                    <md-option ng-repeat="predicate in filter.availableFunctions" ng-value="predicate">{{predicate}}</md-option>
                                                </md-select>
                                            </md-input-container>
                                        </td>

                                        <td md-cell>
                                            <div layout="row" layout-padding layout-align="center center">
                                                <div layout="column" flex="50">
                                                    <md-input-container ng-repeat="(idx, param) in filter.availableFunctionParameters">
                                                        <label>{{param}}</label>
                                                        <input type="text"
                                                               id="{{edge}}-pre-{{filter.property}}-{{filter.predicate}}-{{param}}"
                                                               ng-model="filter.parameters[idx]">
                                                    </md-input-container>
                                                </div>
                                                <p ng-show="filter.availableFunctionParameters.length > 0 && filter.propertyClass" flex="50">
                                                    You may need to
                                                    explicitly
                                                    tell Gaffer the type of
                                                    the
                                                    parameter, e.g:
                                                    {"{{filter.propertyClass}}":
                                                    value}
                                                </p>
                                            </div>

                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                                <md-button id="{{edge}}-add-pre-filter"
                                           ng-click="ctrl.addFilterFunction(ctrl.expandEdgesContent, edge, true)"
                                           ng-show="ctrl.getEdgeProperties(edge)">
                                    Add Pre Aggregation filter
                                </md-button>
                                <table md-table
                                       ng-show="ctrl.getEdgeProperties(edge)">
                                    <tbody md-body>
                                    <tr md-row ng-repeat="filter in ctrl.expandEdgesContent[edge].filters.postAggregation">
                                        <td md-cell>
                                            <md-input-container flex>
                                                <label>Select a property</label>
                                                <md-select id="{{edge}}-post-property-selector"
                                                           ng-model="filter.property"
                                                           ng-change="ctrl.onSelectedPropertyChange(edge, filter)">
                                                    <md-option ng-repeat="(name, type) in ctrl.getEdgeProperties(edge)" ng-value="name">{{name}}</md-option>
                                                </md-select>
                                            </md-input-container>
                                        </td>
                                        <td md-cell>
                                            <md-input-container flex>
                                                <label>Select a predicate</label>
                                                <md-select
                                                        id="{{edge}}-post-{{filter.property}}-predicate-selector"
                                                        ng-model="filter.predicate"
                                                        ng-change="ctrl.onSelectedFunctionChange(edge, filter)">
                                                    <md-option ng-repeat="predicate in filter.availableFunctions" ng-value="predicate">{{predicate}}</md-option>
                                                </md-select>
                                            </md-input-container>
                                        </td>

                                        <td md-cell>
                                            <div layout="row" layout-padding layout-align="center center">
                                                <div layout="column" flex="50">
                                                    <md-input-container ng-repeat="(idx, param) in filter.availableFunctionParameters">
                                                        <label>{{param}}</label>
                                                        <input type="text"
                                                               id="{{edge}}-post-{{filter.property}}-{{filter.predicate}}-{{param}}"
                                                               ng-model="filter.parameters[idx]">
                                                    </md-input-container>
                                                </div>
                                                <p ng-show="filter.availableFunctionParameters.length > 0 && filter.propertyClass" flex="50">
                                                    You may need to
                                                    explicitly
                                                    tell Gaffer the type of
                                                    the
                                                    parameter, e.g:
                                                    {"{{filter.propertyClass}}":
                                                    value}
                                                </p>
                                            </div>

                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                                <md-button id="{{edge}}-add-post-filter"
                                           ng-click="ctrl.addFilterFunction(ctrl.expandEdgesContent, edge, false)"
                                           ng-show="ctrl.getEdgeProperties(edge)">
                                    Add Post Aggregation filter
                                </md-button>
                            </div>
                        </div>
                    </div>


                    <div ng-show="ctrl.selectedOp.inOutFlag">
                        <h3 class="md-headline">Other options</h3>

                        <h4
                                class="md-title">
                            In Out Edges
                        </h4>

                        <div id="inOutFlag">
                            <md-radio-group
                                    ng-model="ctrl.inOutFlag">
                                <md-radio-button value="INCOMING">
                                    Incoming
                                </md-radio-button>
                                <md-radio-button value="OUTGOING">
                                    Outgoing
                                </md-radio-button>
                                <md-radio-button value="EITHER">
                                    Either
                                </md-radio-button>
                            </md-radio-group>
                        </div>
                    </div>
                </md-tab>

                <md-tab label="Execute"
                        ng-disabled="ctrl.step != 2">
                    <p ng-show="!ctrl.expandQueryCounts && ctrl.selectedOp.arrayOutput">
                        Calculating number of results...
                    </p>

                    <div ng-show="ctrl.expandQueryCounts">
                        <p ng-show="ctrl.expandQueryCounts.limitHit">
                            The number of results may exceed
                            limit of {{settings.resultLimit}}.
                            Only the first {{settings.resultLimit}}
                            results will be used.
                        </p>

                        <p ng-show="!ctrl.expandQueryCounts.limitHit">
                            Number of results will be:
                            {{ctrl.expandQueryCounts.count}}
                        </p>
                    </div>
                </md-tab>
            </md-tabs>
        </div>
    </md-dialog-content>

    <md-dialog-actions layout="row">
        <span flex></span>
        <md-button ng-click="ctrl.cancel($event)">
            Cancel
        </md-button>
        <md-button ng-show="ctrl.step != 0"
                   ng-click="ctrl.goToPrevStep()">

            Back
        </md-button>
        <md-button id="build-query-next"
                   ng-show="ctrl.step == 1"
                   ng-click="ctrl.goToNextStep()">
            Next
        </md-button>
        <md-button id="build-query-execute"
                   ng-disabled="!(ctrl.step == 2)"
                   ng-click="ctrl.execute()"
                   ng-click="ctrl.execute()"
                   class="md-primary">
            Execute
        </md-button>
    </md-dialog-actions>
</form>